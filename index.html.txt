<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת שליטה וחילוץ - מפרט מבנים</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;700&display=swap');
        body { font-family: 'Assistant', sans-serif; background-color: #1a1a1a; color: #e5e7eb; }
        .glass { background: rgba(31, 41, 55, 0.8); backdrop-filter: blur(8px); border: 1px solid rgba(255, 255, 255, 0.1); }
        #canvas-container { height: 400px; width: 100%; position: relative; cursor: pointer; border-radius: 12px; overflow: hidden; transition: all 0.3s ease; }
        #canvas-container.fullscreen { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 9999; border-radius: 0; }
        .pulse-red { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #ef4444; }
    </style>
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.module.js",
          "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.150.1/examples/jsm/"
        }
      }
    </script>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto space-y-6">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center glass p-6 rounded-2xl">
            <div class="flex items-center space-x-4 space-x-reverse mb-4 md:mb-0">
                <div class="w-12 h-12 bg-red-600 rounded-full flex items-center justify-center pulse-red">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                    </svg>
                </div>
                <div>
                    <h1 class="text-2xl font-bold uppercase tracking-tight">מערכת מודיעין מבנים - כב"א</h1>
                    <p class="text-sm text-gray-400">גישה לנתוני הנדסה וסכמות חילוץ בזמן אמת</p>
                </div>
            </div>
            <div class="w-full md:w-96 relative">
                <input id="address-input" type="text" placeholder="הזן כתובת (לדוגמה: עונות השנה 5, נס ציונה)" 
                       class="w-full bg-gray-900 border border-gray-700 rounded-lg py-3 px-4 focus:ring-2 focus:ring-red-500 outline-none transition-all">
                <button id="search-btn" class="absolute left-2 top-2 bg-red-600 hover:bg-red-700 text-white px-4 py-1 rounded-md transition-colors">
                    חפש
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <div id="result-view" class="grid grid-cols-1 lg:grid-cols-2 gap-6 hidden">
            <!-- Data Section (Left) -->
            <div class="glass p-6 rounded-2xl overflow-y-auto max-h-[750px] space-y-6">
                <div>
                    <h2 class="text-xl font-bold border-b border-gray-700 pb-2 mb-4 text-red-500">מפרט טכני מבצעי</h2>
                    <div id="spec-content" class="space-y-4">
                        <!-- Technical Data Injected Here -->
                    </div>
                </div>

                <!-- External Info Section (Map & Links) -->
                <div class="border-t border-gray-700 pt-6">
                    <h3 class="text-lg font-bold mb-4 text-blue-400">מיקום ומידע חיצוני</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Google Maps Box -->
                        <div id="map-container" class="w-full h-48 bg-gray-800 rounded-lg overflow-hidden border border-gray-600">
                            <!-- Iframe injected here -->
                            <div class="w-full h-full flex items-center justify-center text-gray-500 text-xs">מפה בטעינה...</div>
                        </div>
                        <!-- Links Box -->
                        <div class="flex flex-col space-y-3">
                            <a id="madlan-link" href="#" target="_blank" class="flex items-center justify-between bg-blue-900/30 hover:bg-blue-800/50 border border-blue-500 p-4 rounded-lg transition-all group">
                                <span class="font-bold text-blue-100">מידע באתר מדלן</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-400 group-hover:translate-x-[-4px] transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                </svg>
                            </a>
                            <div class="bg-gray-800/50 p-4 rounded-lg border border-gray-700">
                                <p class="text-xs text-gray-400 mb-1">מרכז מידע עירוני:</p>
                                <p class="text-sm font-bold">נס ציונה - מוקד 106</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3D Visualization Section (Right) -->
            <div class="glass p-6 rounded-2xl flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-red-500">הדמיית שלד (X-Ray)</h2>
                    <span class="text-xs bg-gray-700 px-2 py-1 rounded">לחץ על המודל להגדלה</span>
                </div>
                <div id="canvas-container">
                    <div id="loading-overlay" class="absolute inset-0 flex items-center justify-center bg-black/50 z-10 hidden">
                        <span class="text-white font-bold">טוען מודל...</span>
                    </div>
                </div>
                <div class="mt-4 text-xs text-gray-500 text-center italic">
                    * המודל הינו סימולציה הנדסית לצורכי חילוץ בלבד.
                </div>
            </div>
        </div>

        <!-- Initial State Info -->
        <div id="initial-state" class="glass p-12 rounded-2xl text-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-600 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
            <p class="text-xl text-gray-500">הזן כתובת לקבלת תוכנית חילוץ, מפה ומפרט הנדסי</p>
        </div>
    </div>

    <!-- 3D Engine Script -->
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        let scene, camera, renderer, controls, buildingGroup;
        const container = document.getElementById('canvas-container');

        function initThree() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0a0a);

            camera = new THREE.PerspectiveCamera(50, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.set(25, 20, 25);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            container.appendChild(renderer.domElement);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;

            const light = new THREE.PointLight(0xffffff, 1);
            light.position.set(20, 20, 20);
            scene.add(light);
            scene.add(new THREE.AmbientLight(0x404040, 2));

            buildingGroup = new THREE.Group();
            scene.add(buildingGroup);

            animate();
        }

        function createBuildingModel(spec) {
            buildingGroup.clear();
            const floors = parseInt(spec.floors) || 5;
            const floorH = 3;
            const bW = 15;
            const bD = 12;

            // Core (Red)
            const coreGeo = new THREE.BoxGeometry(4, floors * floorH, 4);
            const coreMat = new THREE.MeshPhongMaterial({ color: 0xff0000, transparent: true, opacity: 0.8, emissive: 0x220000 });
            const core = new THREE.Mesh(coreGeo, coreMat);
            core.position.y = (floors * floorH) / 2;
            buildingGroup.add(core);

            // Floors
            const skeletonMat = new THREE.MeshPhongMaterial({ color: 0xcccccc, transparent: true, opacity: 0.15, side: THREE.DoubleSide });
            for (let i = 0; i <= floors; i++) {
                const fGeo = new THREE.BoxGeometry(bW, 0.1, bD);
                const f = new THREE.Mesh(fGeo, skeletonMat);
                f.position.y = i * floorH;
                buildingGroup.add(f);

                // Balconies (Blue)
                const bGeo = new THREE.BoxGeometry(4, 0.2, 2);
                const bMat = new THREE.MeshPhongMaterial({ color: 0x4444ff, transparent: true, opacity: 0.6 });
                const b = new THREE.Mesh(bGeo, bMat);
                b.position.set(5, i * floorH + 0.1, bD/2 + 1);
                buildingGroup.add(b);
            }

            // Outer Shell
            const shellGeo = new THREE.BoxGeometry(bW + 0.2, floors * floorH, bD + 0.2);
            const shell = new THREE.Mesh(shellGeo, new THREE.MeshPhongMaterial({ color: 0xffffff, transparent: true, opacity: 0.05 }));
            shell.position.y = (floors * floorH) / 2;
            buildingGroup.add(shell);
            
            camera.position.set(25, 20, 25);
            controls.reset();
        }

        function animate() {
            requestAnimationFrame(animate);
            if(controls) controls.update();
            if(renderer) renderer.render(scene, camera);
        }

        // Logic
        const mockDatabase = {
            "עונות השנה 5, נס ציונה": {
                name: "עונות השנה 5",
                neighborhood: "הוואלי",
                floors: 6,
                units: 14,
                population: "50-60 דיירים (משפחות)",
                safety: "ממ\"ד בכל דירה, ליבת בטון מזוינת",
                hazards: "חניון תת-קרקעי, מערכות גג",
                access: "רחוב הולנדי רחב, גישה למנוף גבהים בחזית",
                madlan: "https://www.madlan.co.il/address/%D7%A2%D7%95%D7%A0%D7%95%D7%AA-%D7%94%D7%A9%D7%A0%D7%94-5-%D7%A0%D7%A1-%D7%A6%D7%99%D7%95%D7%A0%D7%94",
                mapSearch: "עונות+השנה+5+נס+ציונה"
            }
        };

        const input = document.getElementById('address-input');
        const btn = document.getElementById('search-btn');
        const initial = document.getElementById('initial-state');
        const result = document.getElementById('result-view');
        const specDiv = document.getElementById('spec-content');
        const mapDiv = document.getElementById('map-container');
        const madlanBtn = document.getElementById('madlan-link');

        btn.onclick = () => {
            const val = input.value.trim();
            if (!val) return;

            initial.classList.add('hidden');
            result.classList.remove('hidden');

            const data = mockDatabase[val] || {
                name: val,
                neighborhood: "לא ידוע",
                floors: 5,
                units: 10,
                population: "30-40 דיירים",
                safety: "ממ\"ד תקני",
                hazards: "מרפסות שמש",
                access: "גישה מוגבלת",
                madlan: "https://www.madlan.co.il",
                mapSearch: encodeURIComponent(val)
            };

            specDiv.innerHTML = `
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-800 p-3 rounded-lg border border-gray-700"><p class="text-xs text-gray-400">מספר קומות</p><p class="font-bold text-lg text-white">${data.floors}</p></div>
                    <div class="bg-gray-800 p-3 rounded-lg border border-gray-700"><p class="text-xs text-gray-400">יחידות דיור</p><p class="font-bold text-lg text-white">${data.units}</p></div>
                </div>
                <div class="p-4 border-l-4 border-red-600 bg-gray-800 shadow-lg">
                    <h3 class="font-bold text-white mb-1">אוכלוסייה משוערת</h3>
                    <p class="text-sm text-gray-300">${data.population}</p>
                </div>
                <div class="p-4 border-l-4 border-green-600 bg-gray-800 shadow-lg">
                    <h3 class="font-bold text-white mb-1">מערכות הגנה</h3>
                    <p class="text-sm text-gray-300">${data.safety}</p>
                </div>
                <div class="p-4 border-l-4 border-yellow-600 bg-gray-800 shadow-lg">
                    <h3 class="font-bold text-white mb-1">סיכונים ונקודות תורפה</h3>
                    <p class="text-sm text-gray-300">${data.hazards}</p>
                </div>
                <div class="p-4 border-l-4 border-blue-600 bg-gray-800 shadow-lg">
                    <h3 class="font-bold text-white mb-1">דרכי גישה מבצעיות</h3>
                    <p class="text-sm text-gray-300">${data.access}</p>
                </div>
            `;

            // Update Map
            mapDiv.innerHTML = `<iframe width="100%" height="100%" frameborder="0" style="border:0" 
                                src="https://www.google.com/maps/embed/v1/search?key=&q=${data.mapSearch}" allowfullscreen></iframe>`;
            
            // Update Madlan Link
            madlanBtn.href = data.madlan;

            if (!scene) initThree();
            createBuildingModel(data);
        };

        // Fullscreen Toggle
        container.onclick = (e) => {
            container.classList.toggle('fullscreen');
            setTimeout(() => {
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(container.clientWidth, container.clientHeight);
            }, 300);
        };

        window.addEventListener('resize', () => {
            if (!renderer) return;
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        });

    </script>
</body>
</html>